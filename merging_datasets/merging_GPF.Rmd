---
title: "Merging the GPF Datasets"
subtitle: "Strengthening the Dairy Value Chain"
author: "Julia Silge"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: leonids
---

```{r, echo = FALSE, warning = FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, dpi = 180)
options(width=80, dplyr.width = 150)
```

There are five rounds of group performance format (GPF) data collected for this project, in July 2014, December 2014, July 2015, December 2015, and August 2016. Let's work on munging, tidying, and merging these five data sets.

## Reading in the Original Data

First let's read in the file of already merged data for rounds 1 through 4, downloaded from the Google Drive folder.

```{r}
library(readr)
old_gpf_merged <- read_csv("../data/CleanedMergedGFPRounds1234January2016.csv")
```

There are some minor problems with this file; it is not super clean CSV. If we have time, I might want to re-merge the previous rounds. Here are some examples of the issues.

```{r}
kable(tail(problems(old_gpf_merged), 15))
```

## Reading in Round 5

Anyway, let's read in the original Excel files for round 5, downloaded from the Google Drive folder.

```{r}
library(readxl)
library(dplyr)
control_round5 <- left_join(read_excel("../data/SDVCII HH Survey_Excel Version_OSS_05092016.xlsx",
                                       sheet = 1),
                            read_excel("../data/SDVCII HH Survey_Excel Version_OSS_05092016.xlsx", 
                                       sheet = 3, col_types = c("numeric", rep("text", 127)))[,1:66], 
                            by = "DEO ID") %>%
    left_join(read_excel("../data/SDVCII HH Survey_Excel Version_OSS_05092016.xlsx", 
                         sheet = 4, col_types = c("numeric", rep("text", 51))),
              by = "DEO ID") %>%
    left_join(read_excel("../data/SDVCII HH Survey_Excel Version_OSS_05092016.xlsx", 
                         sheet = 5, col_types = c("numeric", rep("text", 127))),
              by = "DEO ID")

control_round5_cows <- read_excel("../data/SDVCII HH Survey_Excel Version_OSS_05092016.xlsx",
                                  sheet = 2)
    

treatment_round5 <- left_join(read_excel("../data/3. SDVCII Endline Database_ August 2016_CARE.xlsx",
                                         sheet = 1),
                              read_excel("../data/3. SDVCII Endline Database_ August 2016_CARE.xlsx", 
                                         sheet = 3, col_types = c("numeric", rep("text", 65))), 
                              by = "DEO ID") %>%
    left_join(read_excel("../data/3. SDVCII Endline Database_ August 2016_CARE.xlsx", 
                         sheet = 4, col_types = c("numeric", rep("text", 51))),
              by = "DEO ID") %>%
    left_join(read_excel("../data/3. SDVCII Endline Database_ August 2016_CARE.xlsx", 
                         sheet = 5, col_types = c("numeric", rep("text", 127))),
              by = "DEO ID")

treatment_round5_cows <- read_excel("../data/3. SDVCII Endline Database_ August 2016_CARE.xlsx",
                                    sheet = 2)

```

## Reading in Round 4

```{r}
treatment_round4 <- left_join(read_excel("../data/gpf_round4/Basic Information.xlsx"),
                              read_excel("../data/gpf_round4/Module 2.xlsx"),
                              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 3 Milk Consumption.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 4.xlsx",
                         col_types = c("numeric", rep("text", 53))),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 5 Expenditure.xlsx",
                         col_types = c("numeric", rep("text", 54))),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module  6.xlsx"),
              by = c("DEO SL" = "Deo SL")) %>%
    left_join(read_excel("../data/gpf_round4/Module 7.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 7 Cattle Died Information.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 8.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Modiul 9.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 10.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 11.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 12.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 13 first part.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 13 Last Part.xlsx",
                         col_types = c("numeric", rep("text", 28))),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round4/Module 13 Women Asset Information.xlsx",
                         col_types = c("numeric", rep("text", 13))),
              by = "DEO SL")

treatment_round4_cows <- read_excel("../data/gpf_round4/Module 3 Cattle Information.xlsx")
```


## Reading in Round 3

```{r}
treatment_round3 <- left_join(read_excel("../data/gpf_round3/Module 1.xlsx"),
                              read_excel("../data/gpf_round3/Module 2.xlsx"),
                              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 3 Milk Consumption.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 4 of 4.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 5 Expenditure.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module  6.xlsx"),
              by = c("DEO SL" = "Deo SL")) %>%
    left_join(read_excel("../data/gpf_round3/Module 7.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 7 Cattle Died Information.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Modiul 8.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Modiul 9.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 10.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 11.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 12.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 13 first part.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 13 Last Part.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round3/Module 13 Women Asset Information.xlsx"),
              by = "DEO SL")

treatment_round3_cows <- read_excel("../data/gpf_round3/Module 3 Cattle Information.xlsx")
```

## Reading in Round 2

```{r}
treatment_round2 <- left_join(read_excel("../data/gpf_round2/Module 1.xlsx"),
                              read_excel("../data/gpf_round2/Module 2.xlsx"),
                              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 3 Milk Consumption.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 4.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 5 Expenditure.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 6.xlsx"),
              by = c("DEO SL" = "Deo SL")) %>%
    left_join(read_excel("../data/gpf_round2/Module 7.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 7 Cattle Died Information.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 8.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 9.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 10.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 11.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 12.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 13 first part.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 13 Last Part.xlsx"),
              by = "DEO SL") %>%
    left_join(read_excel("../data/gpf_round2/Module 13 Women Asset Information.xlsx"),
              by = "DEO SL")

treatment_round2_cows <- read_excel("../data/gpf_round2/Module 3 Cattle Information.xlsx")
```

## Reading in Round 1

```{r}
treatment_round1 <- read_excel("../data/SDVC II Baseline.xlsx",
                               sheet = 1,
                               col_types = rep("text", 469))
```

Let's do some date handling while we're here.

```{r}
library(lubridate)
library(stringr)
grep("calvingdate", names(treatment_round1), value = TRUE)

treatment_round1 <- treatment_round1 %>% 
    mutate(Cow1Lastcalvingdate = dmy(Cow1Lastcalvingdate)) %>%
    mutate(Cow2Lastcalvingdate = dmy(Cow2Lastcalvingdate)) %>%
    mutate(Cow3Lastcalvingdate = dmy(Cow3Lastcalvingdate)) %>%
    mutate(Cow4Lastcalvingdate = dmy(Cow4Lastcalvingdate)) %>%
    mutate(Cow5Lastcalvingdate = dmy(Cow5Lastcalvingdate)) %>%
    mutate(Cow6Lastcalvingdate = dmy(Cow6Lastcalvingdate)) %>%
    mutate(Cow7Lastcalvingdate = dmy(Cow7Lastcalvingdate)) %>%
    mutate(Cow8Lastcalvingdate = dmy(Cow8Lastcalvingdate)) %>%
    mutate(Cow9Lastcalvingdate = dmy(Cow9Lastcalvingdate)) %>%
    mutate(Cow10Lastcalvingdate = dmy(Cow10Lastcalvingdate))

```


## Making Names Consistent

Let's keep a copy of the original column names of all of these so we can get them back if necessary.

```{r}
original_names <- bind_rows(
    data_frame(gpf_type = 'treatment', round = 1, names = list(names(treatment_round1))),
    data_frame(gpf_type = 'treatment', round = 2, names = list(names(treatment_round2))),
    data_frame(gpf_type = 'cows', round = 2, names = list(names(treatment_round2_cows))),
    data_frame(gpf_type = 'treatment', round = 3, names = list(names(treatment_round3))),
    data_frame(gpf_type = 'cows', round = 3, names = list(names(treatment_round3_cows))),
    data_frame(gpf_type = 'treatment', round = 4, names = list(names(treatment_round4))),
    data_frame(gpf_type = 'cows', round = 4, names = list(names(treatment_round4_cows))),
    data_frame(gpf_type = 'treatment', round = 5, names = list(names(treatment_round5))),
    data_frame(gpf_type = 'cows', round = 5, names = list(names(treatment_round5_cows))),
    data_frame(gpf_type = 'control', round = 5, names = list(names(control_round5))),
    data_frame(gpf_type = 'controlcows', round = 5, names = list(names(control_round5_cows)))
    )
```

Now let's make these names consistent so we can merge/join this data together.

```{r}
make_names_consistent <- function(df) {
    names(df) <- names(df) %>%
        tolower() %>%
        str_replace_all("s/he", " ") %>%
        str_replace_all("\\.x|\\.y", "") %>%
        str_replace_all("this |the |of |is |your ", " ") %>%
        str_replace_all("nennbers", "members") %>%
        str_replace_all("hans", "hands") %>%
        str_replace_all("decission", "decision") %>%
        str_replace_all("wrok", "work") %>%
        str_replace_all("satiesfaction", "satisfaction") %>%
        str_replace_all("satiesfied", "satisfied") %>%
        str_replace_all("outside at home", "outside home") %>%
        str_replace_all("mutch", "much") %>%
        str_replace_all("you purchase from", " ") %>%
        str_replace_all("(kg)", " ") %>%
        str_replace_all("who makes decision for use", "decision") %>%
        str_replace_all("who makes decisions for spend", "decision") %>%
        str_replace_all("highly satisfied|moderately satisfied|not satisfied|dissatisfied", "satisfied") %>%
        str_replace_all("do you face any", " ") %>%
        str_replace_all("inpur", "input") %>%
        str_replace_all("input shop", " ") %>%
        str_replace_all("[:punct:]|=", " ") %>%
        str_replace_all("^[0-9 ]+", " ") %>%
        str_replace_all("what is ", " ") %>%
        str_replace_all("what name", "name") %>%
        str_replace_all("geo", "") %>%
        str_trim(side = "both") %>%
        str_replace_all("[ ]{2,}", " ") %>%
        str_replace_all(" ", "_")
    
        colnames(df)[str_detect(names(df), "deo")] <- "deo_id"
        colnames(df)[str_detect(names(df), "respondents_name")] <- "producer_name"
        colnames(df)[str_detect(names(df), "name_respondent")] <- "producer_name"
        colnames(df)[str_detect(names(df), "para_name")] <- "para"
        colnames(df)[str_detect(names(df), "village_name")] <- "village"
        colnames(df)[str_detect(names(df), "union_name")] <- "union"
        colnames(df)[str_detect(names(df), "thana_name")] <- "thana"
        colnames(df)[str_detect(names(df), "district_name")] <- "district"
        colnames(df)[str_detect(names(df), "group_name")] <- "group_name"
        colnames(df)[str_detect(names(df), "hh_type")] <- "household_type"
        colnames(df)[str_detect(names(df), "respondent_s_education")] <- "educational_status_respondent"
        colnames(df)[str_detect(names(df), "what_are_drinking_water_sources_for_cattle")] <- "what_drinking_water_sources_for_cattle"
        colnames(df)[str_detect(names(df), 
                                "does_husband_help_you_in_day_to_day_household_activiti")] <- "does_husband_help_you_in_daily_household_work"
        colnames(df)[str_detect(names(df), 
                                "does_husband_help_you_in_day_to_day_household_activiti")] <- "attended_group_meetings_within_village_need_permission"
        colnames(df)[str_detect(names(df), 
                                "attend_meetings_at_a_distant_place_do_you_have_to_take_permissio")] <- "attend_meetings_at_a_distant_place_need_permission"
        colnames(df)[str_detect(names(df), 
                                "travel_to_distant_place_in_general_like_visit_to_relativeshse_do")] <- "travel_to_distant_place_do_you_have_to_take_permission"
        colnames(df)[str_detect(names(df), 
                                "travel_to_distant_place_in_general_like_visit_to_relativeshse_if")] <- "travel_distant_place_if_yes_from_whom"
        colnames(df)[str_detect(names(df), 
                                "if_yes_from_home")] <- "travel_distant_place_if_yes_from_whom"


        
    df    
}
```

Let's apply this function on our data frames now.

```{r}
treatment_round2 <- treatment_round2 %>%
    make_names_consistent()
treatment_round3 <- treatment_round3 %>%
    make_names_consistent()
treatment_round4 <- treatment_round4 %>%
    make_names_consistent()
treatment_round5 <- treatment_round5 %>%
    make_names_consistent()
control_round5 <- control_round5 %>%
    make_names_consistent()

```

No we have to do some further cleaning up for more inconsistencies.

```{r}
all(names(treatment_round3) %in% names(treatment_round2))

## used code like this to find names that were different 
## but actually should be the same
#names(treatment_round4)[!names(treatment_round4) %in% names(treatment_round2)]
#names(treatment_round2)[!names(treatment_round2) %in% names(treatment_round4)]
```

Round 5 is more different from rounds 2, 3, and 4.

```{r}

treatment_round2 <- treatment_round2 %>%
    select(-hello_my_name_is)

treatment_round3 <- treatment_round3 %>%
    select(-hello_my_name_is)

treatment_round4 <- treatment_round4 %>%
    select(-text11, hello_my_name_is)

colnames(treatment_round5)[74] <- "how_wash_hands"
colnames(treatment_round5)[76] <- "how_wash_milking_pot"
colnames(treatment_round5)[78] <- "how_wash_teat"
colnames(treatment_round5)[237] <- "cow_buy_if_yes_how_many"
colnames(treatment_round5)[241] <- "cow_sell_if_yes_how_many"
colnames(treatment_round5)[245] <- "calf_buy_if_yes_how_many"
colnames(treatment_round5)[269] <- "cow_died_if_yes_how_many"
colnames(treatment_round5)[128] <- "attended_group_meetings_within_village_if_yes_from_whom"
colnames(treatment_round5)[130] <- "attend_meetings_at_a_distant_place_if_yes_from_whom"
colnames(treatment_round5)[95] <- "total_score_health"
colnames(treatment_round5)[101] <- "total_score_cowshed"

colnames(control_round5)[74] <- "how_wash_hands"
colnames(control_round5)[76] <- "how_wash_milking_pot"
colnames(control_round5)[78] <- "how_wash_teat"
colnames(control_round5)[95] <- "total_score_health"
colnames(control_round5)[101] <- "total_score_cowshed"
colnames(control_round5)[237] <- "cow_buy_if_yes_how_many"
colnames(control_round5)[241] <- "cow_sell_if_yes_how_many"
colnames(control_round5)[245] <- "calf_buy_if_yes_how_many"
colnames(control_round5)[269] <- "cow_died_if_yes_how_many"
colnames(control_round5)[128] <- "attended_group_meetings_within_village_if_yes_from_whom"
colnames(control_round5)[130] <- "attend_meetings_at_a_distant_place_if_yes_from_whom"


treatment_round5 <- treatment_round5 %>%
    select(-my_name_is) %>%
    rename(affected_by_disease_2 = affected_by_disease_yes_or_no_2,
           affected_by_disease_3 = affected_by_disease_what_did_you_do_3,
           affected_by_disease_4 = affected_by_disease_who_provide_treatment_4,
           affected_by_disease_5 = affected_by_disease_who_sugested_5,
           affected_by_disease_6 = affected_by_disease_fee_6,
           affected_by_disease_7 = affected_by_disease_diagnos_7,
           affected_by_disease_8 = affected_by_disease_medicine_8,
           vaccinated_2 = vaccinated_yes_or_no_2,
           vaccinated_4 = vaccinated_who_provide_treatment_4,
           vaccinated_5 = vaccinated_who_sugested_5,
           vaccinated_6 = vaccinated_fee_6,
           vaccinated_7 = vaccinated_diagnos_7,
           vaccinated_8 = vaccinated_vaccine_8,
           dewormed_2 = dewormed_yes_or_no_2,
           dewormed_4 = dewormed_who_provide_treatment_4,
           dewormed_5 = dewormed_who_sugested_5,
           dewormed_6 = dewormed_fee_6,
           dewormed_7 = dewormed_diagnos_7,
           dewormed_8 = dewormed_vaccine_8,
           dewormed_9 = dewormed_total_9,
           provided_ai_2 = provided_ai_yes_or_no_2,
           provided_ai_4 = provided_ai_who_provide_services_4,
           provided_ai_9 = provided_ai_total_9,
           provided_ni_2 = provided_ni_yes_or_no_2,
           provided_ni_4 = provided_ni_who_provide_services_4,
           provided_ni_9 = provided_ni_total_9,
           cow_buy_yes_no = did_you_purchase_any_cattle_last_6_months,
           cow_buy_type_cow = what_type_cattle_purchased,
           cow_buy_breed_cow = breed_type,
           cow_sell_yes_no = did_you_sell_any_cattle_last_6_months,
           cow_sell_type_cow = what_type_cattle,
           calf_sell_yes_no = did_you_sell_any_calf_last_6_months,
           calf_sell_type_cow = calf_identification_1,
           calf_sell_breed_cow = breed_1,
           calf_sell_calf_sex = sex_1,
           calf_sell_price_cow = selling_price_1,
           calf_sell_selling_month = selling_month_1,
           if_you_sell_cow_why_sold = if_yes_why_sold,
           did_you_have_any_calf_born_in_last_6_months = did_any_calf_born_last_6_months,
           how_many_calf_born = if_yes_how_many_cow_was_born,
           cow_died_yes_1_no_2 = did_any_cattle_die_during_last_6_months,
           cow_died_type_cow = type_death_cattle,
           cow_died_calf_sex = if_calf_sex,
           causes_death_cow = what_was_cause_death_cow,
           causes_death_calf = what_was_cause_death_calve)


control_round5 <- control_round5 %>%
    select(-my_name_is)


names(treatment_round4)[!names(treatment_round4) %in% names(treatment_round5)]
names(treatment_round5)[!names(treatment_round5) %in% names(treatment_round4)]

names(treatment_round2)[!names(treatment_round2) %in% names(treatment_round5)]
names(treatment_round5)[!names(treatment_round5) %in% names(treatment_round2)]

names(control_round5)[!names(control_round5) %in% names(treatment_round5)]
names(treatment_round5)[!names(treatment_round5) %in% names(control_round5)]


```



## Calculating Cattle Information

## Merging All Rounds




                    
                    
                    