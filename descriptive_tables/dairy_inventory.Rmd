---
title: "SDVC Final Report Descriptive Tables"
subtitle: "Dairy Cattle Inventory and Milk Production"
author: "Julia Silge"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: yes
---

```{r, echo = FALSE, warning = FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, dpi = 180)
#knitr::opts_chunk$set(echo = FALSE)
options(width=80, dplyr.width = 150)
library(ggplot2)
theme_set(theme_light())
```

ISSUES:

* No number of births in the last 6 months in round 1, that I can find.
* Add up other/etc to see if it adds up to the new "all" for priority to drink milk?


Before we make some pretty tables, let's read in the data.

```{r}
library(readr)
library(forcats)
library(dplyr)
library(reshape2)
gpf_ppt <- read_csv("../data/gpf_ppt_merged.csv", 
                    col_types = cols(.default = col_character()))
dim(gpf_ppt)

gpf_ppt <- gpf_ppt %>%
    mutate(round_month = fct_recode(round,
                              `Jul 2014` = '1.0',
                              `Dec 2014` = '2.0',
                              `Jul 2015` = '3.0',
                              `Dec 2015` = '4.0',
                              `Jul 2016` = '5.0')) %>%
    mutate(household_type = fct_collapse(household_type,
                                         Treatment = c("1", "2", "3"),
                                         Control = c("4", "5", "6")))

gpf_ppt[,c(1,22,27:35,36,273:276,324,326)] <- lapply(gpf_ppt[,c(1,22,27:35,36,273:276,324,326)], as.numeric)

gpf_ppt$district_gpf[gpf_ppt$district_gpf == "pabna"] <- "Pabna"
gpf_ppt$district_gpf[gpf_ppt$district_gpf == "Jaipur Hat"] <- "Joypurhat"
gpf_ppt$district_gpf[gpf_ppt$district_gpf == "Natore"] <- "Nator"
gpf_ppt$district_gpf[gpf_ppt$district_gpf == "Shirajgong"] <- "Sirajgonj"
gpf_ppt$district_gpf[gpf_ppt$district_gpf == "Shirajgonj"] <- "Sirajgonj"
gpf_ppt$district_gpf[gpf_ppt$district_gpf == "Sirajgang"] <- "Sirajgonj"
gpf_ppt$district_gpf[gpf_ppt$district_gpf == "Sirajganj"] <- "Sirajgonj"

```

## Make a Producers Data Frame

```{r}
producers <- bind_rows(gpf_ppt %>% 
                           filter(round_month == 'Jul 2014') %>% 
                           distinct(entry_id, .keep_all = TRUE),
                       gpf_ppt %>%
                           filter(round_month != 'Jul 2014') %>%
                           distinct(household_type, deo_id, round, .keep_all = TRUE)) %>%
    ungroup()
                    
dim(producers)    
```


## 1. Cattle inventory by household, by district

```{r, fig.width=7, fig.height=7}
library(tidyr)
df <- bind_rows(gpf_ppt %>% 
                    filter(round_month == 'Jul 2014') %>% 
                    group_by(district_gpf, household_type, entry_id) %>% 
                    summarize(cows = n()) %>% 
                    mutate(deo_id = entry_id,
                           round_month = 'Jul 2014'),
                gpf_ppt %>% 
                    filter(round_month == 'Jul 2016') %>% 
                    group_by(district_gpf, household_type, deo_id) %>% 
                    summarize(cows = n()) %>% 
                    mutate(round_month = 'Jul 2016')) %>%
    group_by(round_month, district_gpf, household_type) %>%
    summarize(median = median(cows, na.rm = TRUE)) %>%
    filter(!is.na(median)) %>%
    complete(household_type)
    ungroup

df %>% 
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", "Treatment/Control",
                        "Median Number of Cattle per Household"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, median, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Number of Cattle per Household") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=7, fig.height=8}
df <- bind_rows(gpf_ppt %>% 
                    filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
                    group_by(district_gpf, entry_id) %>% 
                    summarize(cows = n()) %>% 
                    mutate(deo_id = entry_id,
                           round_month = 'Jul 2014'),
                gpf_ppt %>% 
                    filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
                    group_by(round_month, district_gpf, deo_id) %>% 
                    summarize(cows = n())) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) %>%
    group_by(round_month, district_gpf) %>%
    summarize(median = median(cows, na.rm = TRUE)) %>%
    filter(!is.na(median)) %>%
    ungroup()

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", 
                        "Median Number of Cattle per Household"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    facet_wrap(~ district_gpf) +
    labs(x = NULL, y = "Median Number of Cattle per Household") +
    theme(axis.text.x= element_text(angle=45, hjust = 1))

```

## 2. Number of local breed cattle per household, per district

```{r, fig.width=7, fig.height=7}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014') %>% 
              filter(cow_breed == 1) %>% 
              group_by(district_gpf, household_type, entry_id) %>% 
              summarize(cows = n()) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month == 'Jul 2016') %>% 
              filter(cow_breed == 1) %>% 
              group_by(district_gpf, household_type, deo_id) %>% 
              summarize(cows = n()) %>% 
              mutate(round_month = 'Jul 2016')) %>%
    group_by(round_month, district_gpf, household_type) %>%
    summarize(median = median(cows, na.rm = TRUE)) %>%
    filter(!is.na(median)) %>%
    complete(household_type)

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", "Treatment/Control", 
                        "Median Number of Local Breed Cattle per Household"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, median, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Number of Local Breed Cattle per Household") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=7, fig.height=8}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
              filter(cow_breed == 1) %>% 
              group_by(district_gpf, entry_id) %>% 
              summarize(cows = n()) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
              filter(cow_breed == 1) %>% 
              group_by(round_month, district_gpf, deo_id) %>% 
              summarize(cows = n())) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) %>%
    group_by(round_month, district_gpf) %>%
    summarize(median = median(cows, na.rm = TRUE)) %>%
    filter(!is.na(median))

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", 
                        "Median Number of Local Breed Cattle per Household"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    facet_wrap(~ district_gpf) +
    labs(x = NULL, y = "Median Number of Local Breed Cattle per Household") +
    theme(axis.text.x= element_text(angle=45, hjust = 1))

```


## 3. Number of cross breed cattle per household, per district

```{r, fig.width=7, fig.height=7}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014') %>% 
              filter(cow_breed == 2) %>% 
              group_by(district_gpf, household_type, entry_id) %>% 
              summarize(cows = n()) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month == 'Jul 2016') %>% 
              filter(cow_breed == 2) %>% 
              group_by(district_gpf, household_type, deo_id) %>% 
              summarize(cows = n()) %>% 
              mutate(round_month = 'Jul 2016')) %>%
    group_by(round_month, district_gpf, household_type) %>%
    summarize(median = median(cows, na.rm = TRUE)) %>%
    filter(!is.na(median) & district_gpf != "Naogaon") 
df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", "Treatment/Control", 
                        "Median Number of Cross Breed Cattle per Household"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, median, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Number of Cross Breed Cattle per Household") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=7, fig.height=8}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
              filter(cow_breed == 1) %>% 
              group_by(district_gpf, entry_id) %>% 
              summarize(cows = n()) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
              filter(cow_breed == 1) %>% 
              group_by(round_month, district_gpf, deo_id) %>% 
              summarize(cows = n())) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) %>%
    group_by(round_month, district_gpf) %>%
    summarize(median = median(cows, na.rm = TRUE)) %>%
    filter(!is.na(median)) %>%
    ungroup()

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", 
                        "Median Number of Cross Breed Cows per Household"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    facet_wrap(~ district_gpf) +
    labs(x = NULL, y = "Median Number of Cross Breed Cattle per Household") +
    theme(axis.text.x= element_text(angle=45, hjust = 1))

```


## 4. Percentage of in-milking cows

DELETING

## 5. Average and Median Number of births per cow, per district

```{r, fig.width=7, fig.height=7}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014') %>% 
              filter(cow_type %in% c(1:3, 7)) %>% 
              group_by(district_gpf, household_type, entry_id) %>% 
              summarize(cows = n(),
                        births = max(how_many_calf_born)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month == 'Jul 2016') %>% 
              filter(cow_type %in% c(1:3, 7)) %>% 
              group_by(district_gpf, household_type, deo_id) %>% 
              summarize(cows = n(),
                        births = max(how_many_calf_born)) %>% 
              mutate(round_month = 'Jul 2016')) %>%
    ungroup %>%
    group_by(round_month, district_gpf, household_type) %>%
    summarize(rate = median(births/cows, na.rm = TRUE)) %>%
    ungroup %>%
    complete(household_type) %>%
    select(round_month, district_gpf, household_type, rate)

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "District", "Treatment/Control", 
                        "Median Number of Births per Female Adult Cow (Last 6 Months)"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, rate, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Number of Births per Female Adult Cow (Last 6 Months)") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=7, fig.height=8}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
              filter(cow_type %in% c(1:3, 7)) %>% 
              group_by(district_gpf, entry_id) %>% 
              summarize(cows = n(),
                        births = max(how_many_calf_born)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
              filter(cow_type %in% c(1:3, 7)) %>% 
              group_by(round_month, district_gpf, deo_id) %>% 
              summarize(cows = n(),
                        births = max(how_many_calf_born))) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) %>%
    group_by(round_month, district_gpf) %>%
    summarize(rate = median(births/cows, na.rm = TRUE)) %>%
    ungroup()

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "District", 
                        "Median Number of Births per Female Adult Cow (Last 6 Months)"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, rate)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    facet_wrap(~ district_gpf) +
    labs(x = NULL, y = "Median Number of Births per Female Adult Cow (Last 6 Months)") +
    theme(axis.text.x= element_text(angle=45, hjust = 1))

```


## 6. Value of local breed and cross breed cows in BDT, by district

```{r, fig.width=7, fig.height=7}
gpf_ppt <- gpf_ppt %>% ungroup

df <- full_join(
    gpf_ppt %>% 
        filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
        group_by(round_month, district_gpf, household_type) %>% 
        filter(cow_breed == 1) %>% 
        summarise(median1 = median(cow_value_bdt, na.rm = TRUE)), 
    gpf_ppt %>% 
        filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
        group_by(round_month, district_gpf, household_type) %>% 
        filter(cow_breed == 2) %>% 
        summarise(median2 = median(cow_value_bdt, na.rm = TRUE))) %>%
    filter(district_gpf != "Naogaon")

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", "Treatment/Control", 
                        "Median Value of Local Breed Cattle in BDT",
                        "Median Value of Cross Breed Cattle in BDT"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, median1, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Value of Local Breed Cattle in BDT") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))

df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, median2, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Value of Cross Breed Cattle in BDT") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=7, fig.height=8}
df <- full_join(
    gpf_ppt %>% 
        filter(!is.na(round_month) & household_type == "Treatment") %>%
        group_by(round_month, district_gpf) %>% 
        filter(cow_breed == 1) %>% 
        summarise(`Local Breed` = median(cow_value_bdt, na.rm = TRUE)), 
    gpf_ppt %>% 
        filter(!is.na(round_month) & household_type == "Treatment") %>%
        group_by(round_month, district_gpf) %>% 
        filter(cow_breed == 2) %>% 
        summarise(`Cross Breed` = median(cow_value_bdt, na.rm = TRUE))) 

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "District", 
                        "Median Value of Local Breed Cattle in BDT",
                        "Median Value of Cross Breed Cattle in BDT"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(melt(df), aes(round_month, value, fill = variable)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~ district_gpf) +
    labs(x = NULL, y = "Median Value of Cattle in BDT") +
    theme(legend.title=element_blank()) +
    theme(axis.text.x= element_text(angle=45, hjust = 1)) +
    scale_fill_manual(values = c("#fee08b", "#abdda4"))

```

## 7. Productivity per in milk cow

```{r, fig.width=7, fig.height=7}
gpf_ppt$cow_daily_production[gpf_ppt$cow_daily_production == 0] <- NA

df <- gpf_ppt %>% 
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, district_gpf, household_type) %>% 
    summarise(median1 = median(cow_daily_production, na.rm = TRUE)) %>%
    filter(district_gpf != "Naogaon")

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "District", "Treatment/Control", 
                        "Median Productivity per In-Milk Cow in Liters"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, median1, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Productivity per In-Milk Cow in Liters") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=7, fig.height=8}
df <- gpf_ppt %>% 
        filter(!is.na(round_month) & household_type == "Treatment") %>%
        group_by(round_month, district_gpf) %>% 
        summarise(median1 = median(cow_daily_production, na.rm = TRUE)) 

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "District", 
                        "Median Productivity per In-Milk Cow in Liters"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median1)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    facet_wrap(~ district_gpf) +
    labs(x = NULL, y = "Median Productivity per In-Milk Cow in Liters") +
    theme(axis.text.x= element_text(angle=45, hjust = 1))

```

## 8. Daily household production of cows in liters, by district

```{r, fig.width=7, fig.height=7}
df <- bind_rows(gpf_ppt %>% 
                    filter(round_month == 'Jul 2014') %>% 
                    group_by(district_gpf, household_type, entry_id) %>% 
                    summarize(cows = sum(cow_daily_production, na.rm = TRUE)) %>% 
                    mutate(deo_id = entry_id,
                           round_month = 'Jul 2014'),
                gpf_ppt %>% 
                    filter(round_month == 'Jul 2016') %>% 
                    group_by(district_gpf, household_type, deo_id) %>% 
                    summarize(cows = sum(cow_daily_production, na.rm = TRUE)) %>% 
                    mutate(round_month = 'Jul 2016')) %>%
    filter(district_gpf != "Naogaon")


df$cows[df$cows == 0] <- NA
df <- df %>%
    group_by(round_month, district_gpf, household_type) %>%
    summarize(median1 = median(cows, na.rm = TRUE)) 

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "District", "Treatment/Control", 
                        "Median Daily Household Milk Production in Liters"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")


df %>% 
    complete(household_type) %>%
    ggplot(aes(round_month, median1, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    facet_wrap(~district_gpf) +
    labs(x = NULL, y = "Median Daily Household Milk Production in Liters") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```


```{r, fig.width=7, fig.height=8}
df <- bind_rows(gpf_ppt %>% 
                    filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
                    group_by(district_gpf, entry_id) %>% 
                    summarize(cows = sum(cow_daily_production, na.rm = TRUE)) %>% 
                    mutate(deo_id = entry_id,
                           round_month = 'Jul 2014'),
                gpf_ppt %>% 
                    filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
                    group_by(round_month, district_gpf, deo_id) %>% 
                    summarize(cows = sum(cow_daily_production, na.rm = TRUE))) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) 

df$cows[df$cows == 0] <- NA
df <- df %>%
    group_by(round_month, district_gpf) %>%
    summarize(median1 = median(cows, na.rm = TRUE)) 

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "District",
                        "Median Daily Household Milk Production in Liters"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median1)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    facet_wrap(~ district_gpf) +
    labs(x = NULL, y = "Median Productivity per In-Milk Cow in Liters") +
    theme(axis.text.x= element_text(angle=45, hjust = 1))

```

## 9. Value of Herd

```{r, fig.width=6, fig.height=4}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014') %>% 
              group_by(household_type, entry_id) %>% 
              summarize(cows = sum(cow_value_bdt, na.rm = TRUE)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month == 'Jul 2016') %>% 
              group_by(household_type, deo_id) %>% 
              summarize(cows = sum(cow_value_bdt, na.rm = TRUE)) %>% 
              mutate(round_month = 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarize(median = median(cows, na.rm = TRUE)) 

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Median Value of Herd in BDT"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

ggplot(df, aes(round_month, median, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Median Value of Herd in BDT") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=6, fig.height=4}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
              group_by(entry_id) %>% 
              summarize(cows = sum(cow_value_bdt, na.rm = TRUE)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
              group_by(round_month, deo_id) %>% 
              summarize(cows = sum(cow_value_bdt, na.rm = TRUE))) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) %>%
    group_by(round_month) %>%
    summarize(median = median(cows, na.rm = TRUE)) 

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", 
                        "Median Value of Herd in BDT"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    labs(x = NULL, y = "Median Productivity of Herd in Liters")
```


## 10. Productivity of Herd

```{r, fig.width=6, fig.height=4}
gpf_ppt$cow_daily_production[gpf_ppt$cow_daily_production == 0] <- NA

df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014') %>% 
              group_by(household_type, entry_id) %>% 
              summarize(cows = sum(cow_daily_production)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month == 'Jul 2016') %>% 
              group_by(household_type, deo_id) %>% 
              summarize(cows = sum(cow_daily_production)) %>% 
              mutate(round_month = 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarize(median = median(cows, na.rm = TRUE))

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Median Productivity of Herd in Liters"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")


ggplot(df, aes(round_month, median, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Median Productivity of Herd in Liters") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r,  fig.width=6, fig.height=4}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
              group_by(entry_id) %>% 
              summarize(cows = sum(cow_daily_production)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
              group_by(round_month, deo_id) %>% 
              summarize(cows = sum(cow_daily_production))) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) %>%
    group_by(round_month) %>%
    summarize(median = median(cows, na.rm = TRUE))

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", 
                        "Median Productivity of Herd in Liters"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    labs(x = NULL, y = "Median Productivity of Herd in Liters")

```





## 11. Total Income from Milk Sales (Tk.) per day

```{r, fig.width=6, fig.height=5}
df <- producers %>%
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarize(median1 = median(yesterday_total_income_from_milk_sale, na.rm = TRUE))
    
df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Median Daily Income from Milk Sales in Taka"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

ggplot(df, aes(round_month, median1, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Median Daily Income from Milk Sales in Taka") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=6, fig.height=5}
df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014') %>% 
              filter(cow_type == 1) %>% 
              group_by(district_gpf, household_type, entry_id) %>% 
              summarize(cows = n(),
                        income = max(yesterday_total_income_from_milk_sale)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month == 'Jul 2016') %>% 
              filter(cow_type == 1) %>% 
              group_by(district_gpf, household_type, deo_id) %>% 
              summarize(cows = n(),
                        income = max(yesterday_total_income_from_milk_sale)) %>% 
              mutate(round_month = 'Jul 2016')) %>%
    ungroup %>%
    group_by(round_month, household_type) %>%
    summarize(rate = median(income/cows, na.rm = TRUE))

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Median Daily Income from Milk Sales Per In-Milk Cow in Taka"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

ggplot(df, aes(round_month, rate, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Median Daily Income from Milk Sales Per In-Milk Cow in Taka") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```



```{r, fig.width=6, fig.height=5}
df <- producers %>% 
    filter(household_type == "Treatment") %>% 
    group_by(round_month) %>% 
    summarize(median1 = median(yesterday_total_income_from_milk_sale, na.rm = TRUE))
 
df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", 
                        "Median Daily Income from Milk Sales in Taka"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, median1)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    labs(x = NULL, y = "Median Daily Income from Milk Sales in Taka")
```


```{r, fig.width=6, fig.height=5}

df <- bind_rows(gpf_ppt %>% 
              filter(round_month == 'Jul 2014' & household_type == "Treatment") %>% 
              filter(cow_type == 1) %>% 
              group_by(district_gpf, entry_id) %>% 
              summarize(cows = n(),
                        income = max(yesterday_total_income_from_milk_sale)) %>% 
              mutate(deo_id = entry_id,
                     round_month = 'Jul 2014'),
          gpf_ppt %>% 
              filter(round_month %in% c('Dec 2014', 'Jul 2015','Dec 2015', 'Jul 2016') & household_type == "Treatment") %>% 
              filter(cow_type == 1) %>% 
              group_by(round_month, district_gpf, deo_id) %>% 
              summarize(cows = n(),
                        income = max(yesterday_total_income_from_milk_sale))) %>%
    ungroup %>%
    mutate(round_month = fct_relevel(round_month,
                              'Jul 2014',
                              'Dec 2014',
                              'Jul 2015',
                              'Dec 2015',
                              'Jul 2016')) %>% 
    ungroup %>%
    group_by(round_month) %>%
    summarize(rate = median(income/cows, na.rm = TRUE))

df %>%
    kable(digits = 0,
          col.names = c("Round of Data Collection", 
                        "Median Daily Income from Milk Sales Per In-Milk Cow in Taka"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, rate)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    labs(x = NULL, y = "Median Daily Income from Milk Sales Per In-Milk Cow in Taka")
```


## 12. Total Milk Consumption in Liters

```{r, fig.width=6, fig.height=5}
producers$total_consumption_ltr[producers$total_consumption_ltr == 0] <- NA

df <- producers %>% 
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarise(mean1 = mean(total_consumption_ltr, na.rm = TRUE)) 

df %>%
    kable(digits = 2,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Average Total Milk Consumption in Liters"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

ggplot(df, aes(round_month, mean1, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Average Total Milk Consumption in Liters") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=7, fig.height=5}
df <- producers %>% 
    filter(household_type == "Treatment") %>% 
    group_by(round_month) %>% 
    summarize(mean1 = mean(total_consumption_ltr, na.rm = TRUE))
 
df %>%
    kable(digits = 2,
          col.names = c("Round of Data Collection", 
                        "Average Total Milk Consumption in Liters"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, mean1)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    labs(x = NULL, y = "Average Total Milk Consumption in Liters")
```

```{r, fig.width=6, fig.height=5}
producers$no_family_members_total[producers$no_family_members_total == 0] <- NA

df <- producers %>% 
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarise(mean1 = mean(total_consumption_ltr/no_family_members_total, 
                           na.rm = TRUE)) 

df %>%
    kable(digits = 2,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Average Milk Consumption per Person in Household in Liters"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

ggplot(df, aes(round_month, mean1, fill = household_type)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Average Milk Consumption per Person in Household in Liters") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43"))
```

```{r, fig.width=6, fig.height=5}
df <- producers %>% 
    filter(household_type == "Treatment") %>% 
    group_by(round_month) %>% 
    summarize(mean1 = mean(total_consumption_ltr/no_family_members_total, 
                           na.rm = TRUE))
 
df %>%
    kable(digits = 2,
          col.names = c("Round of Data Collection", 
                        "Average Milk Consumption per Person in Household in Liters"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(round_month, mean1)) +
    geom_bar(alpha = 0.8, stat = "identity", fill = "#66c2a5") +
    labs(x = NULL, y = "Average Milk Consumption per Person in Household in Liters")
```



## 13. Milk Consumption Priorities (proportions/percentages)


```{r}
producers <- producers %>%
    mutate(within_household_who_given_priority_to_consumed_milk = fct_collapse(within_household_who_given_priority_to_consumed_milk,
                                         `Male child` = c("1", "1.", "Boy child",
                                                          "Boy Child",
                                                          "boy", "Boy", 
                                                          "Boy chaild", 
                                                          "Children Boy",
                                                          "Little Boy",
                                                          "Grand son",
                                                          "Grandson",
                                                          "Male chiildren",
                                                          "Male children",
                                                          "Male Children",
                                                          "Male baby",
                                                          "Boys"),
                                         `Female child` = c("2", "2.", 
                                                            "Female baby", 
                                                            "Girl",
                                                            "Girl child",
                                                            "Girls",
                                                            "Granddaughter",
                                                            "Little Girl",
                                                            "Small girl",
                                                            "Small Girl",
                                                            "Daughter of son"),
                                         `Son` = c("3", "3.",
                                                   "Baby (Son)",
                                                   "Small son",
                                                   "Small Son",
                                                   "son",
                                                   "Son",
                                                   "Son Child",
                                                   "Youngest son",
                                                   "Younger Son",
                                                   "Psycali distoried son"),
                                         `Daughter` = c("4", "4.",
                                                        "Yougest daughters",
                                                        "Doughter",
                                                        "Small daughter",
                                                        "Small Daughter",
                                                        "Daughter children",
                                                        "Daughter Children"),
                                         `Other children` = c("Child",
                                                              "1,2",
                                                              "3,4",
                                                              "Boy, Girl",
                                                              "Children",
                                                              "Childs",
                                                              "Son & Daughter",
                                                              "Son & Girl",
                                                              "Small child",
                                                              "Son&Daughter",
                                                              "1,3", "2,3",
                                                              "Boy & Girl",
                                                              "Boy,Girl",
                                                              "Small Child",
                                                              "Small",
                                                              "Boy & girl",
                                                              "Boy Girl",
                                                              "Son and daughter",
                                                              "Son and Daughter",
                                                              "Son & girl",
                                                              "Son, Daughter",
                                                              "1,2,3,4",
                                                              "1,2,4",
                                                              "1,3,4",
                                                              "Boy child, girl child",
                                                              "Boy girl",
                                                              "child"),
                                         `Husband` = c("5", "5.",
                                                       "Husband",
                                                       "house hold head",
                                                       "House hold head"),
                                         `Wife` = c("6", "6.",
                                                    "Wife",
                                                    "wife",
                                                    "Son's wife"),
                                         `Old man` = c("7", "7.",
                                                       "Old man",
                                                       "Father in law",
                                                       "Father in Low",
                                                       "Father in low",
                                                       "Father"),
                                         `Old woman` = c("8", "8.",
                                                         "Mother",
                                                         "Mother in low",
                                                         "Grand Mother"),
                                         `All members` = c("9", "9.",
                                                           "Alawys is equal",
                                                           "All",
                                                           "All family",
                                                           "All family members",
                                                           "All is equal",
                                                           "All member",
                                                           "All member of family",
                                                           "All People",
                                                           "All people is equal",
                                                           "All people of family",
                                                           "Drink all people",
                                                           "Equal",
                                                           "Equeal eat",
                                                           "Everybody",
                                                           "There eat equal",
                                                           "To all",
                                                           "All time eat",
                                                           "Both equal",
                                                           "Family main",
                                                           "Familly main.",
                                                           "Drink by all"))) %>%
    mutate(within_household_who_given_priority_to_consumed_milk = fct_lump(within_household_who_given_priority_to_consumed_milk, n = 10))

```

```{r, fig.height=8, fig.width=6}
totals <- producers %>% 
    group_by(round_month, household_type, within_household_who_given_priority_to_consumed_milk) %>% 
    summarise(n = n()) %>% 
    filter(!is.na(within_household_who_given_priority_to_consumed_milk)) %>%
    group_by(round_month, household_type) %>% 
    summarise(total = sum(n, na.rm = TRUE))


df <- producers %>% 
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, household_type, within_household_who_given_priority_to_consumed_milk) %>% 
    summarise(n = n()) %>%
    filter(!is.na(within_household_who_given_priority_to_consumed_milk)) %>%
    left_join(totals, by = c("round_month", "household_type")) %>%
    mutate(prop = n / total*100) %>%
    select(-n, -total)

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Who Is Given Priority to Consume Milk?", "Percent"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")

ggplot(df, aes(within_household_who_given_priority_to_consumed_milk, prop/100, fill = household_type)) +
    geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
    facet_wrap(~ round_month, ncol = 1) +
    labs(y = NULL, x = "Who Is Given Priority to Consume Milk?") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43")) +
    coord_flip()

```

```{r, fig.width=8, fig.height=8}
df <- producers %>% 
    filter(household_type == "Treatment") %>% 
    group_by(round_month, within_household_who_given_priority_to_consumed_milk) %>% 
    summarise(n = n()) %>%
    mutate(household_type = "Treatment") %>%
    filter(!is.na(within_household_who_given_priority_to_consumed_milk)) %>%
    left_join(totals, by = c("round_month", "household_type")) %>%
    mutate(prop = n / total*100) %>%
    select(-n, -total, -household_type) %>%
    complete(within_household_who_given_priority_to_consumed_milk)
 
df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", 
                        "Who Is Given Priority to Consume Milk?", "Percent"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(df, aes(within_household_who_given_priority_to_consumed_milk, prop/100, fill = round_month)) +
    geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
    labs(y = NULL, x = "Who Is Given Priority to Consume Milk?") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#fdae61", "#fee08b", "#e6f598", "#abdda4", "#66c2a5")) +
    coord_flip()
    
```



## 14. Milk Distribution Patterns – litres

```{r, fig.width=8, fig.height=6}
producers$total_free_distribution_ltr[producers$total_free_distribution_ltr == 0] <- NA
producers$neighbors[producers$neighbors == 0] <- NA
producers$collection_point[producers$collection_point == 0] <- NA
producers$milk_collector[producers$milk_collector == 0] <- NA
producers$open_market[producers$open_market == 0] <- NA
producers$sweetmeat_tea_stall[producers$sweetmeat_tea_stall == 0] <- NA
producers$direct_to_company[producers$direct_to_company == 0] <- NA
producers$yesterday_total_spoilage_ltr[producers$yesterday_total_spoilage_ltr == 0] <- NA


df <- producers %>% 
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarise(`Given for Free` = median(total_free_distribution_ltr, na.rm = TRUE),
              `Sold to Neighbors` = median(neighbors, na.rm = TRUE),
              `Sold at DFT` = median(collection_point, na.rm = TRUE),
              `Sold to Collector` = median(milk_collector, na.rm = TRUE),
              `Sold at Open Market` = median(open_market, na.rm = TRUE),
              `Sold at Sweetmeat Shop` = median(sweetmeat_tea_stall, na.rm = TRUE),
              `Sold Direct to Company` = median(direct_to_company, na.rm = TRUE),
              Spoiled = median(yesterday_total_spoilage_ltr, na.rm = TRUE)) 

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Milk Given Away for Free (Liters)", "Milk Sold to Neighbors (Liters)",
                        "Milk Sold at DFT (Liters)", "Milk Sold to Milk Collector (Liters)",
                        "Milk Sold at Open Market (Liters)", "Milk Sold at Sweetmeat Shop (Liters)",
                        "Milk Sold Directly to Company (Liters)", "Milk Spoiled (Liters)"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")


ggplot(melt(df), aes(variable, value, fill = household_type)) +
    geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
    facet_wrap(~round_month) +
    labs(y = "Liters of Milk", x = "Where is Milk Distributed?") +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43")) +
    coord_flip()

```

```{r, fig.width=8, fig.height=5}
df <- producers %>% 
    filter(!is.na(round_month) & household_type == "Treatment") %>%
    group_by(round_month) %>%
    summarise(`Given for Free` = median(total_free_distribution_ltr, na.rm = TRUE),
              `Sold to Neighbors` = median(neighbors, na.rm = TRUE),
              `Sold at DFT` = median(collection_point, na.rm = TRUE),
              `Sold to Collector` = median(milk_collector, na.rm = TRUE),
              `Sold at Open Market` = median(open_market, na.rm = TRUE),
              `Sold at Sweetmeat Shop` = median(sweetmeat_tea_stall, na.rm = TRUE),
              `Sold Direct to Company` = median(direct_to_company, na.rm = TRUE),
              Spoiled = median(yesterday_total_spoilage_ltr, na.rm = TRUE)) 

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", 
                        "Milk Given Away for Free (Liters)", "Milk Sold to Neighbors (Liters)",
                        "Milk Sold at DFT (Liters)", "Milk Sold to Milk Collector (Liters)",
                        "Milk Sold at Open Market (Liters)", "Milk Sold at Sweetmeat Shop (Liters)",
                        "Milk Sold Directly to Company (Liters)", "Milk Spoiled (Liters)"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(melt(df), aes(round_month, value, fill = variable)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Milk in Liters") +
    theme(legend.title=element_blank()) +
    scale_fill_brewer(palette = "Spectral")
```


## 15. Milk Distribution Patterns – percentages

```{r, fig.width=8, fig.height=6}
library(tidyr)
totals <- producers %>% 
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarise(`Given for Free` = median(total_free_distribution_ltr, na.rm = TRUE),
              `Sold to Neighbors` = median(neighbors, na.rm = TRUE),
              `Sold at DFT` = median(collection_point, na.rm = TRUE),
              `Sold to Collector` = median(milk_collector, na.rm = TRUE),
              `Sold at Open Market` = median(open_market, na.rm = TRUE),
              `Sold at Sweetmeat Shop` = median(sweetmeat_tea_stall, na.rm = TRUE),
              `Sold Direct to Company` = median(direct_to_company, na.rm = TRUE),
              Spoiled = median(yesterday_total_spoilage_ltr, na.rm = TRUE)) %>%
    group_by(round_month, household_type) %>%
    summarize(sum = sum(`Given for Free`,
                        `Sold to Neighbors`,
                        `Sold at DFT`,
                        `Sold to Collector`,
                        `Sold at Open Market`,
                        `Sold at Sweetmeat Shop`,
                        `Sold Direct to Company`,
                        Spoiled, na.rm = TRUE)) %>%
    select(round_month, household_type, sum)


df <- producers %>% 
    filter(round_month %in% c('Jul 2014', 'Jul 2016')) %>%
    group_by(round_month, household_type) %>%
    summarise(`Given for Free` = median(total_free_distribution_ltr, na.rm = TRUE),
              `Sold to Neighbors` = median(neighbors, na.rm = TRUE),
              `Sold at DFT` = median(collection_point, na.rm = TRUE),
              `Sold to Collector` = median(milk_collector, na.rm = TRUE),
              `Sold at Open Market` = median(open_market, na.rm = TRUE),
              `Sold at Sweetmeat Shop` = median(sweetmeat_tea_stall, na.rm = TRUE),
              `Sold Direct to Company` = median(direct_to_company, na.rm = TRUE),
              Spoiled = median(yesterday_total_spoilage_ltr, na.rm = TRUE)) %>%
    melt() %>%
    left_join(totals) %>%
    mutate(proportion = 100*value/sum) %>%
    select(round_month, household_type, variable, proportion) %>%
    spread(key = variable, value = proportion)

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", "Treatment/Control", 
                        "Milk Given Away for Free (%)", "Milk Sold to Neighbors (%)",
                        "Milk Sold at DFT (%)", "Milk Sold to Milk Collector (%)",
                        "Milk Sold at Open Market (%)", "Milk Sold at Sweetmeat Shop (%)",
                        "Milk Sold Directly to Company (%)", "Milk Spoiled (%)"),
          caption = "Treatment and Control Groups at the First and Last Data Collection Rounds")


ggplot(melt(df), aes(variable, value/100, fill = household_type)) +
    geom_bar(stat = "identity", position = "dodge", alpha = 0.8) +
    facet_wrap(~round_month) +
    labs(y = NULL, x = "Where is Milk Distributed?") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme(legend.title=element_blank()) +
    scale_fill_manual(values = c("#3288bd", "#f46d43")) + 
    coord_flip()
```

```{r, fig.width=8, fig.height=5}
totals <- producers %>% 
    filter(!is.na(round_month) & household_type == "Treatment") %>%
    group_by(round_month) %>%
    summarise(`Given for Free` = median(total_free_distribution_ltr, na.rm = TRUE),
              `Sold to Neighbors` = median(neighbors, na.rm = TRUE),
              `Sold at DFT` = median(collection_point, na.rm = TRUE),
              `Sold to Collector` = median(milk_collector, na.rm = TRUE),
              `Sold at Open Market` = median(open_market, na.rm = TRUE),
              `Sold at Sweetmeat Shop` = median(sweetmeat_tea_stall, na.rm = TRUE),
              `Sold Direct to Company` = median(direct_to_company, na.rm = TRUE),
              Spoiled = median(yesterday_total_spoilage_ltr, na.rm = TRUE)) %>%
    group_by(round_month) %>%
    summarize(sum = sum(`Given for Free`,
                        `Sold to Neighbors`,
                        `Sold at DFT`,
                        `Sold to Collector`,
                        `Sold at Open Market`,
                        `Sold at Sweetmeat Shop`,
                        `Sold Direct to Company`,
                        Spoiled, na.rm = TRUE)) %>%
    select(round_month, sum)

df <- producers %>% 
    filter(!is.na(round_month) & household_type == "Treatment") %>%
    group_by(round_month) %>%
    summarise(`Given for Free` = median(total_free_distribution_ltr, na.rm = TRUE),
              `Sold to Neighbors` = median(neighbors, na.rm = TRUE),
              `Sold at DFT` = median(collection_point, na.rm = TRUE),
              `Sold to Collector` = median(milk_collector, na.rm = TRUE),
              `Sold at Open Market` = median(open_market, na.rm = TRUE),
              `Sold at Sweetmeat Shop` = median(sweetmeat_tea_stall, na.rm = TRUE),
              `Sold Direct to Company` = median(direct_to_company, na.rm = TRUE),
              Spoiled = median(yesterday_total_spoilage_ltr, na.rm = TRUE)) %>%
    melt() %>%
    left_join(totals) %>%
    mutate(proportion = 100*value/sum) %>%
    select(round_month, variable, proportion) %>%
    spread(key = variable, value = proportion)

df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", 
                        "Milk Given Away for Free (%)", "Milk Sold to Neighbors (%)",
                        "Milk Sold at DFT (%)", "Milk Sold to Milk Collector (%)",
                        "Milk Sold at Open Market (%)", "Milk Sold at Sweetmeat Shop (%)",
                        "Milk Sold Directly to Company (%)", "Milk Spoiled (%)"),
          caption = "Treatment Group at All Data Collection Rounds")

ggplot(melt(df), aes(round_month, value/100, fill = variable)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Amount of Milk") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme(legend.title=element_blank()) +
    scale_fill_brewer(palette = "Spectral")
```

## 16. Market Linkage Choices (proportions)

```{r}
producers %>% 
    group_by(round_month, household_type) %>% 
    summarise(meanNA = mean(is.na(where_do_you_sell_milk_in_general)))


producers %>% 
    group_by(round_month, household_type) %>% 
    summarise(meanNA = mean(is.na(where_do_you_sell_milk_most_often)))
```



```{r, fig.width=8, fig.height=6}
producers$where_do_you_sell_milk_most_often[producers$where_do_you_sell_milk_most_often == 0] <- NA

producers <- producers %>%
    mutate(where_do_you_sell_milk_most_often = fct_recode(where_do_you_sell_milk_most_often,
                              `DFT` = '1',
                              `Open Market` = '2',
                              `Milk Collector` = '3',
                              `Milk Vita` = '4',
                              `PRAN` = '5',
                              `Neighbor` = '6',
                              `Akij` = '7',
                              `DANON` = '8',
                              `Sweetmeat Shop` = '9',
                              `Other` = '99'))
totals <- producers %>% 
    group_by(round_month, household_type, where_do_you_sell_milk_most_often) %>% 
    summarise(n = n()) %>% 
    filter(!is.na(where_do_you_sell_milk_most_often)) %>%
    group_by(round_month, household_type) %>% 
    summarise(total = sum(n, na.rm = TRUE))


df <- producers %>% 
    filter(household_type == "Treatment") %>% 
    group_by(round_month, where_do_you_sell_milk_most_often) %>% 
    summarise(n = n()) %>%
    mutate(household_type = "Treatment") %>%
    filter(!is.na(where_do_you_sell_milk_most_often)) %>%
    left_join(totals, by = c("round_month", "household_type")) %>%
    mutate(prop = n / total*100) %>%
    select(-n, -total, -household_type)
 
df %>%
    kable(digits = 1,
          col.names = c("Round of Data Collection", 
                        "Where Is Milk Sold Most Often?", "Percent"),
          caption = "Treatment Group at All Available Data Collection Rounds")

ggplot(df, aes(round_month, prop/100, fill = where_do_you_sell_milk_most_often)) +
    geom_bar(alpha = 0.8, stat = "identity", position = "dodge") +
    labs(x = NULL, y = "Where Is Milk Sold Most Often?") +
    scale_y_continuous(labels = scales::percent_format()) +
    theme(legend.title=element_blank()) +
    scale_fill_brewer(palette = "Spectral")

```

